#textdomain wesnoth-colosseum-xp

#define CS_SHOP X Y IMAGE

    # Set side variables
    # ==================

    [event]
        name=colosseum prestart
        {CS_SIDEVAR_INIT defup_left  8}
        {CS_SIDEVAR_INIT resup_left  6}
        {CS_SIDEVAR_INIT moveup_left 6}
        {CS_SIDEVAR_INIT feeding     1}
        {CS_SIDEVAR_INIT regenerates 8}
    [/event]

    # Place shop image
    # ================

    [event]
        name=colosseum start
        {PLACE_IMAGE {IMAGE} {X} {Y}}
    [/event]

    # Feeding
    # =======

    [event]
        name=die
        first_time_only=no

        [filter]
            [not]
                [filter_wml]
                    [status]
                        not_living="yes"
                    [/status]
                [/filter_wml]
            [/not]
        [/filter]

        [filter_second]
            ability=cs_feeding
        [/filter_second]

        [unstore_unit]
            variable=second_unit
            {COLOR_HEAL}
            text= _ "+${CS_SIDEVAR feeding $second_unit.side} max HP"
            find_vacant=no
        [/unstore_unit]

        [object]
            silent=yes
            duration=forever

            [filter]
                x,y=$x2,$y2
            [/filter]

            [effect]
                apply_to=hitpoints
                increase_total=${CS_SIDEVAR feeding $second_unit.side}
                increase=${CS_SIDEVAR feeding $second_unit.side}
            [/effect]
        [/object]
    [/event]

    # Events and macros for abilities and specials
    # ============================================

    {~add-ons/Colosseum_XP/macros/abilities}
    {~add-ons/Colosseum_XP/macros/specials}

    {CS_ADVANCE_MENU}

    # Shop label handler
    # ==================

    [event]
        name=colosseum shop set label
        first_time_only=no

        {SET_LABEL {X} {Y} $cs_shop_label}
    [/event]

    # Event to show shop
    # ==================
    
    [event]
        name=colosseum show shop
        first_time_only=no

        [cs_shop]
            name=_"Upgrade"
            image_attr="~SCALE(32,32)"

            {_CS_SHOP_SECTIONS}
        [/cs_shop]
    [/event]

    # Shop moveto handler
    # ===================

    [event]
        name=moveto
        first_time_only=no

        [filter]
            canrecruit=yes
            x,y={X},{Y}
        [/filter]
        
        [if]
            [variable]
                name=cs_state
                equals=shop
            [/variable]

            [then]
                [fire_event]
                    name=colosseum show shop
                    [primary_unit]
                        id=$unit.id
                    [/primary_unit]
                [/fire_event]

                [disallow_end_turn]
                [/disallow_end_turn]
            [/then]
        [/if]
    [/event]

    # Make it impossible to block the shop
    # ====================================

    [event]
        name=moveto
        first_time_only=no

        [filter]
            x,y={X},{Y}
        [/filter]

        [if]
            [variable]
                name=cs_state
                equals=shop
            [/variable]

            [then]
                [disallow_end_turn]
                [/disallow_end_turn]

                {VARIABLE unit.moves "$($unit.max_moves - 1)"}
                [unstore_unit]
                    variable=unit
                    find_vacant=no
                [/unstore_unit]
            [/then]
        [/if]
    [/event]

    [event]
        name=moveto
        first_time_only=no

        [if]
            [variable]
                name=cs_state
                equals=shop
            [/variable]
            [not]
                [have_unit]
                    side=$side_number
                    x,y={X},{Y}
                [/have_unit]
            [/not]

            [then]
                [allow_end_turn]
                [/allow_end_turn]
            [/then]
        [/if]
    [/event]

    # Menu item to re-enter shop in case of accidental exit
    # =====================================================

    [event]
        name=recruit,side turn
        first_time_only=no
    
        [set_menu_item]
            id=cs_enter_shop
            description=_"Enter shop..."

            [show_if]
                [variable]
                    name=cs_state
                    equals=shop
                [/variable]

                [variable]
                    name=x1
                    equals={X}
                [/variable]

                [variable]
                    name=y1
                    equals={Y}
                [/variable]

                [have_unit]
                    side=$side_number
                    canrecruit=yes
                    x,y={X},{Y}
                [/have_unit]
            [/show_if]

            [command]
                [fire_event]
                    name=colosseum show shop
                    [primary_unit]
                        x,y={X},{Y}
                    [/primary_unit]
                [/fire_event]
            [/command]
        [/set_menu_item]
    [/event]
#enddef

#define CS_SHOP_SET_LABEL LABEL
    [set_variable]
        name=cs_shop_label
        value={LABEL}
    [/set_variable]

    [fire_event]
        name=colosseum shop set label
    [/fire_event]
#enddef

# =============================================================================

#define _CS_COLOR_PERCENTAGE IN_VARIABLE OUT_VARIABLE
        {VARIABLE {OUT_VARIABLE} "#ff6622"}

        [if]
            [variable]
                name={IN_VARIABLE }
                greater_than=30
            [/variable]
            [then]
                {VARIABLE {OUT_VARIABLE} "#cccc22"}
            [/then]
        [/if]

        [if]
            [variable]
                name={IN_VARIABLE}
                greater_than=60
            [/variable]
            [then]
                {VARIABLE {OUT_VARIABLE} "#33ff33"}
            [/then]
        [/if]
#enddef

# =============================================================================

#define _CS_SHOP_DEFENSE IMAGE PRICE TERRAIN TEXT
    [item]
        price={PRICE}
        name=_{TEXT}
        benefits=_"current: <span color='$tmp_defense_{TERRAIN}_color'>$tmp_defense_{TERRAIN}|%</span>, max: <span color='#33ff33'>80%</span>"
        image={IMAGE}

        [prepare]
            {VARIABLE tmp_defense_{TERRAIN} 100}
            {VARIABLE_OP tmp_defense_{TERRAIN} add -$tmp_defense_store.defense.{TERRAIN}|}

            {_CS_COLOR_PERCENTAGE tmp_defense_{TERRAIN} tmp_defense_{TERRAIN}_color}
        [/prepare]

        [have_all_if]
            [variable]
                name=tmp_defense_{TERRAIN}
                greater_than_equal_to=80
            [/variable]

            [or]
                [variable]
                    name={CS_SIDEVAR defup_left $side_number}
                    equals=0
                [/variable]
            [/or]
        [/have_all_if]

        [command]
            [object]
                silent=yes
                [effect]
                    apply_to=defense
                    replace=no
                    [defense]
                        {TERRAIN}=-10
                    [/defense]
                [/effect]
            [/object]

            {CS_SIDEVAR_OP defup_left $side_number add -1}
        [/command]
    [/item]
#enddef

# =============================================================================

#define _CS_SHOP_RESISTANCE IMAGE PRICE TYPE TEXT
    [item]
        price={PRICE}
        name=_{TEXT}
        benefits=_"current: <span color='$tmp_resistance_{TYPE}_color'>$tmp_resistance_{TYPE}|%</span>, max: <span color='#33ff33'>70%</span>"
        image={IMAGE}

        [prepare]
            {VARIABLE tmp_resistance_{TYPE} 100}
            {VARIABLE_OP tmp_resistance_{TYPE} add -$tmp_resistance_store.resistance.{TYPE}|}

            {_CS_COLOR_PERCENTAGE tmp_resistance_{TYPE} tmp_resistance_{TYPE}_color}
        [/prepare]

        [have_all_if]
            [variable]
                name=tmp_resistance_{TYPE}
                greater_than_equal_to=70
            [/variable]

            [or]
                [variable]
                    name={CS_SIDEVAR resup_left $side_number}
                    equals=0
                [/variable]
            [/or]
        [/have_all_if]

        [command]
            [object]
                silent=yes
                [effect]
                    apply_to=resistance
                    replace=no
                    [resistance]
                        {TYPE}=-10
                    [/resistance]
                [/effect]
            [/object]

            {CS_SIDEVAR_OP resup_left $side_number add -1}
        [/command]
    [/item]
#enddef

# =============================================================================

#define _CS_SHOP_MOVE IMAGE PRICE TERRAIN TEXT
    [item]
        price={PRICE}
        name=_{TEXT}
        benefits=_"current: <span color='#eeeeee'>$tmp_move_store.movement_costs.{TERRAIN}|</span>"
        image={IMAGE}

        [have_all_if]
            [variable]
                name=tmp_move_store.movement_costs.{TERRAIN}
                less_than_equal_to=1
            [/variable]

            [or]
                [variable]
                    name={CS_SIDEVAR moveup_left $side_number}
                    equals=0
                [/variable]
            [/or]
        [/have_all_if]

        [command]
            [object]
                silent=yes
                [effect]
                    apply_to=movement_costs
                    replace=no
                    [movement_costs]
                        {TERRAIN}=-1
                    [/movement_costs]
                [/effect]
            [/object]

            {CS_SIDEVAR_OP moveup_left $side_number add -1}
        [/command]
    [/item]
#enddef

# =============================================================================

#define _CS_SHOP_ABILITY IMAGE PRICE ID NAME BENEFITS CODE
    [item]
        price={PRICE}
        name=_{NAME}
        image={IMAGE}
        benefits=_{BENEFITS}
        have_all_text=_"already have"

        [have_all_if]
            [have_unit]
                x,y=$x1,$y1
                ability={ID}
            [/have_unit]
        [/have_all_if]

        [command]
            [object]
                silent=yes
                [effect]
                    apply_to=new_ability
                    [abilities]
                        {CODE}
                    [/abilities]
                [/effect]
            [/object]
        [/command]
    [/item]
#enddef

# =============================================================================

#define _CS_SHOP_SECTIONS
    [section]
        name=_"Weapons"
        image="attacks/greatsword-human.png"

        {~add-ons/Colosseum_XP/macros/weapons}
    [/section]

    # =========================================================================

    [section]
        name=_"Utilities"
        image="icons/potion_green_medium.png"

        {_CS_SHOP_ABILITY "attacks/fire-blast.png"
            5 "suicide bomb" "suicide bomb"
            "if you get killed, deals 80 fire damage to surrounding units"
            ({ABILITY_SUICIDE_BOMB})}

        {_CS_SHOP_ABILITY "attacks/lightbeam.png"
            15 teleporter "teleporter"
            "instantly teleport to any location within 5 hex radius, one use"
            ({ABILITY_TELEPORTER})}

        {_CS_SHOP_ABILITY "attacks/lightbeam.png"
            15 garlic "garlic"
            "deals 6 arcane damage to all surrounding undead every turn (upgradeable)"
            ({ABILITY_GARLIC 6})}
    [/section]

    # =========================================================================

    [section]
        name=_"Enhancements"
        image="icons/crossed_sword_and_hammer.png"
        
        [item]
            price=10
            name=_"+1 melee damage"
            image="attacks/ram.png"

            [command]
                [object]
                    silent=yes
                    [effect]
                        apply_to=attack
                        range=melee
                        increase_damage=1
                    [/effect]
                [/object]
            [/command]
        [/item]
        
        [item]
            price=10
            name=_"+1 ranged damage"
            image="attacks/crossbow-iron.png"

            [command]
                [object]
                    silent=yes
                    [effect]
                        apply_to=attack
                        range=ranged
                        increase_damage=1
                    [/effect]
                [/object]
            [/command]
        [/item]

        [item]
            price=16
            name=_"+1 both damage"
            image="attacks/chakram.png"

            [command]
                [object]
                    silent=yes
                    [effect]
                        apply_to=attack
                        increase_damage=1
                    [/effect]
                [/object]
            [/command]
        [/item]

        [item]
            price=35
            name=_"+1 melee strikes"
            image="attacks/fist.png"

            [command]
                [object]
                    silent=yes
                    [effect]
                        apply_to=attack
                        range=melee
                        increase_attacks=1
                    [/effect]
                [/object]
            [/command]
        [/item]
        
        [item]
            price=35
            name=_"+1 ranged strikes"
            image="attacks/rock_thrown.png"

            [command]
                [object]
                    silent=yes
                    [effect]
                        apply_to=attack
                        range=ranged
                        increase_attacks=1
                    [/effect]
                [/object]
            [/command]
        [/item]
        
        [item]
            price=56
            name=_"+1 both strikes"
            image="attacks/sling.png"

            [command]
                [object]
                    silent=yes
                    [effect]
                        apply_to=attack
                        increase_attacks=1
                    [/effect]
                [/object]
            [/command]
        [/item]
        
        [item]
            price=5
            name=_"+4 maximum health"
            image="icons/tunic_elven.png"

            [command]
                [object]
                    silent=yes
                    [effect]
                        apply_to=hitpoints
                        increase_total=4
                        heal_full=yes
                    [/effect]
                [/object]
            [/command]
        [/item]

        [item]
            price=50
            name=_"+40 maximum health"
            image="icons/cuirass_leather_studded.png"

            [command]
                [object]
                    silent=yes
                    [effect]
                        apply_to=hitpoints
                        increase_total=40
                        heal_full=yes
                    [/effect]
                [/object]
            [/command]
        [/item]

        [item]
            price=10
            name=_"+1 movement point"
            image="icons/boots_elven.png"

            [command]
                [object]
                    silent=yes
                    [effect]
                        apply_to=movement
                        increase=1
                    [/effect]
                [/object]
            [/command]
        [/item]

        [item]
            price=30
            name=_"+1 feeding"
            image="attacks/fangs.png"

            [show_if]
                [have_unit]
                    x,y=$x1,$y1
                    ability=feeding
                [/have_unit]

                [or]
                    [have_unit]
                        x,y=$x1,$y1
                        ability=cs_feeding
                    [/have_unit]
                [/or]
            [/show_if]

            [command]
                {CS_SIDEVAR_OP feeding $side_number add 1}

                [object]
                    silent=yes

                    [effect]
                        apply_to=remove_ability
                        [abilities]
                            [dummy]
                                id=feeding
                            [/dummy]
                        [/abilities]
                    [/effect]

                    [effect]
                        apply_to=remove_ability
                        [abilities]
                            [dummy]
                                id=cs_feeding
                            [/dummy]
                        [/abilities]
                    [/effect]

                    [effect]
                        apply_to=new_ability
                        [abilities]
                            [dummy]
                                id=cs_feeding
                                name=_"feeding +${CS_SIDEVAR feeding $side_number}"
                                female_name=_"female^feeding +${CS_SIDEVAR feeding $side_number}"
                                description=_"Feeding +${CS_SIDEVAR feeding $side_number}:
This unit gains ${CS_SIDEVAR feeding $side_number} hitpoint added to its maximum whenever it kills a living unit."
                            [/dummy]
                        [/abilities]
                    [/effect]
                [/object]
            [/command]
        [/item]

        [item]
            price=10
            name=_"+6 regeneration"
            image="attacks/entangle.png"

            [show_if]
                [have_unit]
                    x,y=$x1,$y1
                    ability=regenerates
                [/have_unit]
            [/show_if]

            [command]
                {CS_SIDEVAR_OP regenerates $side_number add 6}

                [object]
                    silent=yes

                    [effect]
                        apply_to=remove_ability
                        [abilities]
                            [dummy]
                                id=regenerates
                            [/dummy]
                        [/abilities]
                    [/effect]

                    [effect]
                        apply_to=new_ability
                        [abilities]
                            [regenerate]
                                value=${CS_SIDEVAR regenerates $side_number}
                                id=regenerates
                                name=_"regenerates +${CS_SIDEVAR regenerates $side_number}"
                                description=_"Regenerates ${CS_SIDEVAR regenerates $side_number}:
The unit will heal itself ${CS_SIDEVAR regenerates $side_number} HP per turn. If it is poisoned, it will remove the poison instead of healing."
                                affect_self=yes
                                poison=cured
                            [/regenerate]
                        [/abilities]
                    [/effect]
                [/object]
            [/command]
        [/item]

        [item]
            price=20
            name=_"+4 garlic damage"
            image="attacks/lightbeam.png"

            [show_if]
                [have_unit]
                    x,y=$x1,$y1
                    ability=garlic
                [/have_unit]
            [/show_if]

            [command]
                {CS_SIDEVAR_OP garlic $side_number add 2}

                [object]
                    silent=yes

                    [effect]
                        apply_to=remove_ability
                        [abilities]
                            [dummy]
                                id=garlic
                            [/dummy]
                        [/abilities]
                    [/effect]

                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {ABILITY_GARLIC ${CS_SIDEVAR garlic $side_number}}
                        [/abilities]
                    [/effect]
                [/object]
            [/command]
        [/item]
    [/section]

    # =========================================================================

    [section]
        name=_"Defenses"
        image="icons/shield_polished.png"

        [indicator]
            name=_"Training left"
            value=${CS_SIDEVAR defup_left $side_number}
        [/indicator]

        [prepare]
            [store_unit]
                [filter]
                    side=$side_number
                    x,y=$x1,$y1
                [/filter]

                variable=tmp_defense_store
            [/store_unit]
        [/prepare]

        [show_if]
            [variable]
                name=tmp_defense_store.advancement.id
                equals=amla_default
            [/variable]
        [/show_if]

        {_CS_SHOP_DEFENSE "terrain/flat/road-clean.png" 
            20 flat       "+10% flat defense"}

        {_CS_SHOP_DEFENSE "terrain/forest/forested-deciduous-summer-hills-tile.png" 
            15 forest     "+10% forest defense"}

        {_CS_SHOP_DEFENSE "terrain/hills/regular.png"
            20 hills      "+10% hills defense"}

        {_CS_SHOP_DEFENSE "terrain/mountains/basic-tile.png"
            15 mountains  "+10% mountains defense"}

        {_CS_SHOP_DEFENSE "terrain/sand/desert-oasis.png"
            15 sand            "+10% sand defense"}

        {_CS_SHOP_DEFENSE "terrain/frozen/snow.png"
            10 frozen     "+10% frozen defense"}

        {_CS_SHOP_DEFENSE "terrain/cave/wall-rough-tile.png"
            15 cave       "+10% cave defense"}

        {_CS_SHOP_DEFENSE    "terrain/water/coast-tile.png"
            15 shallow_water "+10% shallow water defense"}

        {_CS_SHOP_DEFENSE "terrain/castle/castle-tile.png"
            15 castle     "+10% castle defense"}

        {_CS_SHOP_DEFENSE "terrain/forest/mushrooms-beam-tile.png"
            15 fungus     "+10% fungus defense"}
    [/section]

    # =========================================================================

    [section]
        name=_"Resistances"
        image="icons/helmet_bascinet.png"

        [show_if]
            [have_unit]
                side=$side_number
                [not]
                    type=Ghost,Wraith,Spectre
                [/not]
            [/have_unit]
        [/show_if]

        [indicator]
            name=_"Training left"
            value=${CS_SIDEVAR resup_left $side_number}
        [/indicator]

        [prepare]
            [store_unit]
                [filter]
                    side=$side_number
                    x,y=$x1,$y1
                [/filter]

                variable=tmp_resistance_store
            [/store_unit]
        [/prepare]

        {_CS_SHOP_RESISTANCE "attacks/dagger-human.png"
            15 blade  "+10% blade resistance"}
            
        {_CS_SHOP_RESISTANCE "attacks/bow-short.png"
            15 pierce "+10% pierce resistance"}
            
        {_CS_SHOP_RESISTANCE "attacks/hammer.png"
            15 impact "+10% impact resistance"}
            
        {_CS_SHOP_RESISTANCE "attacks/torch.png"
            15 fire   "+10% fire resitance"}
            
        {_CS_SHOP_RESISTANCE "attacks/iceball.png"
            15 cold   "+10% cold resistance"}
            
        {_CS_SHOP_RESISTANCE "attacks/gaze.png"
            15 arcane "+10% arcane resistance"}
    [/section]

    # =========================================================================

    [section]
        name=_"Movement costs"
        image="icons/sandals.png"

        [indicator]
            name=_"Training left"
            value=${CS_SIDEVAR moveup_left $side_number}
        [/indicator]

        [prepare]
            [store_unit]
                [filter]
                    side=$side_number
                    x,y=$x1,$y1
                [/filter]

                variable=tmp_move_store
            [/store_unit]
        [/prepare]

        {_CS_SHOP_MOVE   "terrain/flat/road-clean.png" 
            10 flat           "-1 flat cost"}

        {_CS_SHOP_MOVE   "terrain/forest/forested-deciduous-summer-hills-tile.png" 
            10 forest         "-1 forest cost"}

        {_CS_SHOP_MOVE   "terrain/hills/regular.png"
            10 hills          "-1 hills cost"}

        {_CS_SHOP_MOVE   "terrain/mountains/basic-tile.png"
            10 mountains      "-1 mountains cost"}

        {_CS_SHOP_MOVE   "terrain/sand/desert-oasis.png"
            10 sand           "-1 sand cost"}

        {_CS_SHOP_MOVE   "terrain/frozen/snow.png"
            10 frozen         "-1 frozen cost"}

        {_CS_SHOP_MOVE   "terrain/cave/wall-rough-tile.png"
            10 cave           "-1 cave cost"}

        {_CS_SHOP_MOVE   "terrain/water/coast-tile.png"
            10 shallow_water  "-1 shallow water cost"}

        {_CS_SHOP_MOVE   "terrain/castle/castle-tile.png"
            10 castle         "-1 castle cost"}

        {_CS_SHOP_MOVE   "terrain/forest/mushrooms-beam-tile.png"
            10 fungus         "-1 fungus cost"}
    [/section]

    # =========================================================================

    [section]
        name=_"Abilities"
        image="icons/circlet_winged.png"

        {_CS_SHOP_ABILITY "icons/cuirass_muscled.png"
            20 steadfast "steadfast"
            "when defending, resistances are doubled, up to maximum 50%"
            ({ABILITY_STEADFAST})}

        {_CS_SHOP_ABILITY "icons/jewelry_butterfly_pin.png"
            20 skirmisher "skirmisher"
            "ignore zones of control"
            ({ABILITY_SKIRMISHER})}

        [item]
            price=50
            name=_"feeding"
            image="attacks/fangs.png"
            benefits=_"gain extra maximum health for killing enemies"
            have_all_text=_"already have"

            [have_all_if]
                [have_unit]
                    x,y=$x1,$y1
                    ability=cs_feeding
                [/have_unit]

                [or]
                    [have_unit]
                        x,y=$x1,$y1
                        ability=cs_feeding
                    [/have_unit]
                [/or]
            [/have_all_if]

            [command]
                [object]
                    silent=yes
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            [dummy]
                                id=cs_feeding
                                name= _ "feeding +${CS_SIDEVAR feeding $side_number}"
                                female_name= _ "female^feeding +${CS_SIDEVAR feeding $side_number}"
                                description=_ "Feeding +${CS_SIDEVAR feeding $side_number}:
This unit gains ${CS_SIDEVAR feeding $side_number} hitpoint added to its maximum whenever it kills a living unit."
                            [/dummy]
                        [/abilities]
                    [/effect]
                [/object]
            [/command]
        [/item]

        {_CS_SHOP_ABILITY "attacks/entangle.png"
            50 regenerates "regenerates"
            "regenerate health or cure poison at the beginning of each turn"
            ({ABILITY_REGENERATES})}
    [/section]

    [section]
        name=_"Advancement"
        image="icons/scroll_red.png"

        [show_if]
            [variable]
                name=unit.variables.num_advance
                greater_than=1
            [/variable]
        [/show_if]

        [command]
            [fire_event]
                name=colosseum show advance menu
                [primary_unit]
                    x,y=$x1,$y1
                [/primary_unit]
            [/fire_event]
        [/command]
    [/section]
#enddef
